<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planning | SmartCool Pro</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Improved Gantt Styles */
        .gantt-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .gantt-header {
            display: flex;
            flex-direction: column;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            position: sticky;
            top: 0;
            z-index: 30;
        }

        .gantt-header-row {
            display: flex;
            width: 100%;
        }

        .gantt-task-col {
            width: 300px;
            padding: 10px 20px;
            border-right: 1px solid #e2e8f0;
            background: #f8fafc;
            z-index: 31;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            font-weight: 700;
            color: #334155;
        }

        .gantt-timeline {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            position: relative;
        }

        .gantt-month {
            text-align: center;
            padding: 8px 0;
            border-right: 1px solid #e2e8f0;
            background: #f1f5f9;
            color: #475569;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .gantt-week {
            text-align: center;
            padding: 8px 0;
            border-right: 1px solid #f1f5f9;
            font-size: 0.7rem;
            color: #94a3b8;
        }
        
        .gantt-row {
            display: flex;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
            height: 56px; /* Increased height */
            align-items: center;
            transition: background-color 0.2s;
        }

        .gantt-row:hover {
            background-color: #f8fafc;
        }

        .gantt-task-name {
            width: 300px;
            padding: 0 20px;
            font-size: 0.85rem;
            color: #334155;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-right: 1px solid #e2e8f0;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            height: 100%;
            background: white;
            z-index: 10;
        }

        .gantt-bar-container {
            flex: 1;
            position: relative;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            align-items: center;
        }

        /* Background Grid */
        .gantt-bg-grid {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            pointer-events: none;
            z-index: 1;
        }
        .gantt-bg-line {
            border-right: 1px dashed #f1f5f9;
            height: 100%;
        }
        .gantt-bg-line:nth-child(4n) {
            border-right: 1px solid #e2e8f0; /* Month separator */
        }

        .gantt-bar {
            height: 32px;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            z-index: 5;
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }
        
        .gantt-bar:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.15);
            z-index: 20;
            filter: brightness(1.05);
        }

        .gantt-bar-progress {
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            position: absolute;
            left: 0; top: 0;
            border-radius: 8px 0 0 8px;
            box-shadow: 1px 0 0 rgba(0,0,0,0.1);
        }
        
        .gantt-bar-label {
            position: relative;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Current Week Line */
        .current-week-line {
            position: absolute;
            left: calc((100% / 24) * 4); /* Week 4 */
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ef4444;
            z-index: 25;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }
        .current-week-label {
            position: absolute;
            top: -24px;
            left: -50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: pulse 2s infinite;
        }
        .current-week-label::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #ef4444;
        }
        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
            100% { transform: translateX(-50%) scale(1); }
        }

        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Phase Header */
        .phase-header {
            cursor: pointer;
            user-select: none;
            background: #f1f5f9;
            height: 40px;
        }
        .phase-header:hover {
            background-color: #e2e8f0;
        }
        .phase-toggle-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            transition: transform 0.3s;
            color: var(--accent);
            background: white;
            border-radius: 50%;
            margin-right: 10px;
            font-size: 0.7rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .phase-header.collapsed .phase-toggle-icon {
            transform: rotate(-90deg);
        }
        
        /* Task Rows Animation */
        .task-row {
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 56px;
            opacity: 1;
        }
        .task-row.hidden {
            max-height: 0;
            opacity: 0;
            border-bottom: none;
            margin: 0;
        }

        /* Custom Tooltip */
        .gantt-tooltip {
            position: fixed;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(4px);
            color: white;
            padding: 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            min-width: 240px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .gantt-tooltip-header {
            font-weight: 700;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
            font-size: 1rem;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .gantt-tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 6px;
            align-items: center;
        }
        .gantt-tooltip-label {
            color: #94a3b8;
            font-size: 0.8rem;
        }
        .gantt-tooltip-value {
            font-weight: 600;
            color: #e2e8f0;
        }

        /* Simulation Buttons */
        .btn-sim {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        .btn-delay { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .btn-delay:hover { background: #ffedd5; }
        
        .btn-fail { background: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; }
        .btn-fail:hover { background: #fee2e2; }

        .btn-reset { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .btn-reset:hover { background: #e2e8f0; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: #475569; }
        .form-input { 
            width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; 
            border-radius: 6px; font-size: 0.9rem; 
        }
        .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        
        .modal-actions {
            display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px;
        }
        .btn-primary { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .btn-secondary { background: #e2e8f0; color: #475569; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .btn-danger { background: #fee2e2; color: #ef4444; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }

        /* Gantt Controls */
        .gantt-utility-card { margin-bottom: 16px; }
        .gantt-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 12px; }
        .stat-pill { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #475569; }
        .stat-pill strong { color: #0f172a; font-size: 1.1rem; }
        .gantt-toolbar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        .toolbar-left { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .toolbar-group { display: flex; gap: 8px; align-items: center; }
        .status-pill { border: 1px solid #e2e8f0; background: white; color: #475569; padding: 6px 10px; border-radius: 999px; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; }
        .status-pill.active { background: #e0ecff; border-color: #c7d7ff; color: #1d4ed8; box-shadow: 0 4px 10px -4px rgba(59, 130, 246, 0.3); }
        .status-pill.danger { background: #fff1f2; border-color: #ffe4e6; color: #b91c1c; }
        .status-pill.danger.active { background: #ffe4e6; color: #991b1b; }
        .filter-select { border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px 10px; font-size: 0.9rem; color: #334155; background: white; }
        .filter-search { border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px 10px; font-size: 0.9rem; min-width: 220px; }
        .ghost-button { border: 1px dashed #cbd5e1; background: white; color: #475569; padding: 8px 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .ghost-button:hover { border-color: var(--accent); color: var(--accent); }

    </style>
  </head>
  <body>
    <!-- Edit/Add Modal -->
    <div id="task-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 20px; font-size: 1.2rem;">Edit Task</h2>
            <input type="hidden" id="task-id">
            
            <div class="form-group">
                <label class="form-label">Task Name</label>
                <input type="text" id="task-name" class="form-input" placeholder="e.g., PCB Design">
            </div>
            
            <div class="form-group">
                <label class="form-label">Phase</label>
                <select id="task-phase" class="form-input">
                    <option value="1. INITIATION">1. INITIATION</option>
                    <option value="2. POC">2. POC</option>
                    <option value="3. DEV">3. DEV</option>
                    <option value="4. IND">4. IND</option>
                </select>
            </div>

            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label class="form-label">Start Week</label>
                    <input type="number" id="task-start" class="form-input" min="1" max="24">
                </div>
                <div>
                    <label class="form-label">Duration (Weeks)</label>
                    <input type="number" id="task-duration" class="form-input" min="1" max="10">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="task-status" class="form-input">
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Done">Done</option>
                    <option value="Delayed">Delayed</option>
                    <option value="Critical">Critical</option>
                </select>
            </div>

            <div class="modal-actions">
                <button type="button" onclick="deleteTask()" id="btn-delete" class="btn-danger" style="margin-right: auto;">Delete</button>
                <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                <button type="button" onclick="saveTask()" class="btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <nav class="sidebar">
      <div class="brand">Smart<span>Cool</span></div>
      <div class="nav-links">
        <a href="index.html"><span>Dashboard</span></a>
        <a href="planning.html" class="active"><span>Planning & Gantt</span></a>
        <a href="team.html"><span>Team & Skills</span></a>
        <a href="budget.html"><span>Budget & Resources</span></a>
        <a href="risks.html"><span>Risk Management</span></a>
        <a href="comm.html"><span>Communications</span></a>
        <a href="defense.html"><span>Delivery & Defense</span></a>
      </div>
      <div class="footer">v2.1 | 2025-12-08</div>
    </nav>
    <main class="main-content">
      <header>
        <h1><i class="fas fa-calendar-alt" style="color: var(--accent); margin-right: 10px;"></i>Planning & Gantt</h1>
        <p>Agile Hardware Methodology: 2-Week Sprints & Recursive Updates.</p>
      </header>

      <!-- Simulation Control Panel -->
      <div class="card" style="margin-bottom: 24px; border-left: 4px solid var(--accent);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div>
                <h3 style="font-size: 1.1rem;"><i class="fas fa-flask"></i> Simulation & Recursion</h3>
                <p style="color: var(--text-muted); margin-top: 4px; font-size: 0.9rem;">Test the "Living Plan" by triggering unforeseen events.</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="openAddModal()" class="btn-sim" style="background: #dcfce7; color: #166534; border: 1px solid #bbf7d0;"><i class="fas fa-plus"></i> Add Task</button>
                <button onclick="triggerRisk('delay')" class="btn-sim btn-delay"><i class="fas fa-shipping-fast"></i> Trigger Supply Chain Delay</button>
                <button onclick="triggerRisk('new-task')" class="btn-sim btn-fail"><i class="fas fa-temperature-low"></i> Trigger Sensor Fogging</button>
                <button onclick="resetPlan()" class="btn-sim btn-reset"><i class="fas fa-undo"></i> Reset Plan</button>
            </div>
        </div>
      </div>

      <div class="card" style="margin-bottom: 24px;">
        <h3><i class="fas fa-sync-alt"></i> Methodology</h3>
        <p style="color: var(--text-muted); margin-top: 8px;">
            We utilize an <strong>Agile Hardware</strong> approach. Hardware schematics and software code are synchronized in 2-week sprints. 
            This plan is a <strong>living document</strong>; the Gantt chart below is updated recursively (Weeks 7, 12, 18) based on PoC validation results and supply chain realities.
        </p>
      </div>

      <div class="card gantt-utility-card">
        <div class="gantt-stats">
            <div class="stat-pill">
                <span>Total Tasks</span>
                <strong id="stat-total">--</strong>
            </div>
            <div class="stat-pill">
                <span>In Progress</span>
                <strong id="stat-progress">--</strong>
            </div>
            <div class="stat-pill">
                <span>Done</span>
                <strong id="stat-done">--</strong>
            </div>
            <div class="stat-pill">
                <span>At Risk</span>
                <strong id="stat-risk">--</strong>
            </div>
        </div>

        <div class="gantt-toolbar">
            <div class="toolbar-left">
                <div class="toolbar-group">
                    <label for="filter-phase" style="font-weight:600; color:#475569; font-size:0.9rem;">Phase</label>
                    <select id="filter-phase" class="filter-select" onchange="handlePhaseFilter(this.value)">
                        <option value="all">All Phases</option>
                        <option value="1. INITIATION">1. INITIATION</option>
                        <option value="2. POC">2. POC</option>
                        <option value="3. DEV">3. DEV</option>
                        <option value="4. IND">4. IND</option>
                    </select>
                </div>

                <div class="toolbar-group">
                    <button class="status-pill active" data-status-filter="all" onclick="handleStatusFilter('all')"><i class="fas fa-layer-group"></i>All</button>
                    <button class="status-pill" data-status-filter="In Progress" onclick="handleStatusFilter('In Progress')"><i class="fas fa-play"></i>In Progress</button>
                    <button class="status-pill" data-status-filter="Pending" onclick="handleStatusFilter('Pending')"><i class="fas fa-hourglass-half"></i>Pending</button>
                    <button class="status-pill" data-status-filter="Done" onclick="handleStatusFilter('Done')"><i class="fas fa-check"></i>Done</button>
                    <button class="status-pill danger" data-status-filter="At Risk" onclick="handleStatusFilter('At Risk')"><i class="fas fa-exclamation-triangle"></i>At Risk</button>
                </div>

                <div class="toolbar-group">
                    <input id="filter-search" class="filter-search" type="search" placeholder="Search task..." oninput="handleSearch(this.value)">
                </div>
            </div>

            <div class="toolbar-group">
                <button class="ghost-button" onclick="scrollToCurrentWeek(true)"><i class="fas fa-location-arrow"></i> Focus on Now</button>
                <button class="ghost-button" onclick="resetFilters()"><i class="fas fa-eraser"></i> Clear Filters</button>
            </div>
        </div>
      </div>

      <!-- Tooltip Element -->
      <div id="gantt-tooltip" class="gantt-tooltip"></div>

      <div class="gantt-wrapper" style="position: relative;">
        <!-- Current Week Indicator -->
        <div class="gantt-bar-container" style="position: absolute; top: 40px; left: 300px; width: calc(100% - 300px); height: calc(100% - 40px); pointer-events: none; z-index: 20;">
            <div class="current-week-line">
                <div class="current-week-label">NOW</div>
            </div>
        </div>

        <div class="gantt-header">
          <!-- Month Row -->
          <div class="gantt-header-row" style="border-bottom: 1px solid #e2e8f0;">
              <div class="gantt-task-col" style="background: #f1f5f9; border-right: 1px solid #e2e8f0;"></div>
              <div class="gantt-timeline">
                <div class="gantt-month" style="grid-column: span 4">Nov '25</div>
                <div class="gantt-month" style="grid-column: span 4">Dec '25</div>
                <div class="gantt-month" style="grid-column: span 4">Jan '26</div>
                <div class="gantt-month" style="grid-column: span 4">Feb '26</div>
                <div class="gantt-month" style="grid-column: span 4">Mar '26</div>
                <div class="gantt-month" style="grid-column: span 4">Apr '26</div>
              </div>
          </div>
          <!-- Week Row -->
          <div class="gantt-header-row">
              <div class="gantt-task-col">Task Name</div>
              <div class="gantt-timeline">
                <div class="gantt-week">W1</div><div class="gantt-week">W2</div><div class="gantt-week">W3</div><div class="gantt-week">W4</div>
                <div class="gantt-week">W5</div><div class="gantt-week">W6</div><div class="gantt-week">W7</div><div class="gantt-week">W8</div>
                <div class="gantt-week">W9</div><div class="gantt-week">W10</div><div class="gantt-week">W11</div><div class="gantt-week">W12</div>
                <div class="gantt-week">W13</div><div class="gantt-week">W14</div><div class="gantt-week">W15</div><div class="gantt-week">W16</div>
                <div class="gantt-week">W17</div><div class="gantt-week">W18</div><div class="gantt-week">W19</div><div class="gantt-week">W20</div>
                <div class="gantt-week">W21</div><div class="gantt-week">W22</div><div class="gantt-week">W23</div><div class="gantt-week">W24</div>
              </div>
          </div>
        </div>

        <div id="gantt-rows-container">
            <!-- Loading State -->
            <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Loading Project Timeline...</p>
            </div>
        </div>

      </div>
      
      <div style="margin-top: 15px; display: flex; gap: 20px; font-size: 0.8rem; color: var(--text-muted);">
          <div><span style="display:inline-block; width:12px; height:12px; background:#3b82f6; border-radius:2px; margin-right:5px;"></span>Initiation</div>
          <div><span style="display:inline-block; width:12px; height:12px; background:#8b5cf6; border-radius:2px; margin-right:5px;"></span>PoC</div>
          <div><span style="display:inline-block; width:12px; height:12px; background:#10b981; border-radius:2px; margin-right:5px;"></span>Development</div>
          <div><span style="display:inline-block; width:12px; height:12px; background:#f59e0b; border-radius:2px; margin-right:5px;"></span>Industrialization</div>
      </div>
    </main>
    <script>
        const weeksTotal = 24;
        const projectStart = new Date('2025-11-03');
        let ganttData = [];
        const filterState = {
            phase: 'all',
            statuses: new Set(['all']),
            search: ''
        };

        updateStatusPills();
        loadGantt();

        function loadGantt() {
            fetch('/api/gantt')
                .then(res => res.json())
                .then(tasks => {
                    ganttData = tasks || [];
                    applyFilters();
                });
        }

        function applyFilters() {
            const searchTerm = filterState.search.trim().toLowerCase();
            const filtered = ganttData.filter(task => {
                const matchPhase = filterState.phase === 'all' || task.phase === filterState.phase;
                const matchSearch = !searchTerm || task.task.toLowerCase().includes(searchTerm);
                const isRisk = task.status === 'Delayed' || task.status === 'Critical';
                const statuses = filterState.statuses;
                const matchStatus = statuses.has('all') || statuses.has(task.status) || (statuses.has('At Risk') && isRisk);
                return matchPhase && matchSearch && matchStatus;
            });

            renderGantt(filtered);
            updateStats(filtered);
            updateCurrentWeekLine();
            setTimeout(() => scrollToCurrentWeek(false), 60);
        }

        function handleStatusFilter(status) {
            if (status === 'all') {
                filterState.statuses = new Set(['all']);
            } else {
                filterState.statuses.delete('all');
                if (filterState.statuses.has(status)) filterState.statuses.delete(status);
                else filterState.statuses.add(status);
                if (filterState.statuses.size === 0) filterState.statuses.add('all');
            }
            updateStatusPills();
            applyFilters();
        }

        function updateStatusPills() {
            const statuses = filterState.statuses;
            document.querySelectorAll('[data-status-filter]').forEach(btn => {
                const key = btn.getAttribute('data-status-filter');
                const isRisk = key === 'At Risk';
                const active = statuses.has('all') ? key === 'all' : statuses.has(key) || (isRisk && (statuses.has('At Risk')));
                btn.classList.toggle('active', active);
            });
        }

        function handlePhaseFilter(value) {
            filterState.phase = value;
            applyFilters();
        }

        function handleSearch(value) {
            filterState.search = value;
            applyFilters();
        }

        function resetFilters() {
            filterState.phase = 'all';
            filterState.statuses = new Set(['all']);
            filterState.search = '';
            document.getElementById('filter-phase').value = 'all';
            document.getElementById('filter-search').value = '';
            updateStatusPills();
            applyFilters();
        }

        function updateStats(list) {
            const total = list.length;
            const inProgress = list.filter(t => t.status === 'In Progress').length;
            const done = list.filter(t => t.status === 'Done').length;
            const risk = list.filter(t => t.status === 'Delayed' || t.status === 'Critical').length;
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-progress').innerText = inProgress;
            document.getElementById('stat-done').innerText = done;
            document.getElementById('stat-risk').innerText = risk;
        }

        function getCurrentWeekIndex() {
            if (isNaN(projectStart)) return 1;
            const now = new Date();
            const diffMs = now - projectStart;
            const week = Math.floor(diffMs / (7 * 24 * 60 * 60 * 1000)) + 1;
            return Math.min(Math.max(1, week), weeksTotal);
        }

        function updateCurrentWeekLine() {
            const weekIndex = getCurrentWeekIndex();
            const line = document.querySelector('.current-week-line');
            const label = document.querySelector('.current-week-label');
            if (!line || !label) return;
            line.style.left = `calc((100% / ${weeksTotal}) * ${weekIndex - 1})`;
            label.textContent = `W${weekIndex}`;
        }

        function scrollToCurrentWeek(force) {
            const wrapper = document.querySelector('.gantt-wrapper');
            const weekIndex = getCurrentWeekIndex();
            const weeks = document.querySelectorAll('.gantt-week');
            const target = weeks[weekIndex - 1];
            if (!wrapper || !target) return;
            const left = target.offsetLeft - 160; // keep task names visible
            if (force) {
                wrapper.scrollTo({ left, behavior: 'smooth' });
            } else if (wrapper.scrollLeft === 0) {
                wrapper.scrollLeft = Math.max(left, 0);
            }
        }

        function renderGantt(tasks) {
            const container = document.getElementById('gantt-rows-container');
            if (!tasks.length) {
                container.innerHTML = `
                    <div style="padding: 32px; text-align: center; color: var(--text-muted);">
                        <i class="fas fa-search" style="font-size: 1.4rem; margin-bottom: 8px;"></i>
                        <p>No tasks match the current filters.</p>
                    </div>`;
                return;
            }

            let currentPhase = '';
            let phaseIndex = 0;
            const gridBg = `<div class="gantt-bg-grid">${'<div class="gantt-bg-line"></div>'.repeat(24)}</div>`;

            container.innerHTML = tasks.map(task => {
                let html = '';
                if (task.phase !== currentPhase) {
                    currentPhase = task.phase;
                    phaseIndex++;
                    html += `
                    <div class="gantt-row phase-header" onclick="togglePhase(${phaseIndex})">
                        <div class="gantt-task-name">
                            <span class="phase-toggle-icon" id="icon-phase-${phaseIndex}"><i class="fas fa-chevron-down"></i></span>
                            <strong>${task.phase}</strong>
                        </div>
                        <div class="gantt-bar-container">${gridBg}</div>
                    </div>`;
                }

                const progress = getProgressFromStatus(task.status);
                const maxDuration = 25 - task.start_week;
                const displayDuration = Math.min(task.duration, maxDuration);
                const endWeek = task.start_week + displayDuration - 1;

                let displayColor = task.color;
                if (task.status === 'Critical') displayColor = '#ef4444';
                else if (task.status === 'Delayed') displayColor = '#f97316';
                else if (task.status === 'Done') displayColor = '#64748b';

                html += `
                <div class="gantt-row task-row phase-group-${phaseIndex}">
                    <div class="gantt-task-name" style="padding-left: 40px;">
                        <i class="fas ${task.icon}" style="margin-right: 8px; color: #94a3b8; width: 16px;"></i> ${task.task}
                    </div>
                    <div class="gantt-bar-container">
                        ${gridBg}
                        <div class="gantt-bar" 
                                style="grid-column: ${task.start_week} / span ${displayDuration}; width: 100%; background: ${displayColor};" 
                                data-id="${task.id}"
                                data-task="${task.task}"
                                data-start="${task.start_week}"
                                data-end="${endWeek}"
                                data-duration="${task.duration}"
                                data-status="${task.status}"
                                data-phase="${task.phase}"
                                data-progress="${progress}%"
                                onclick="openEditModal(this.dataset)"
                                onmouseenter="showTooltip(event, this)"
                                onmousemove="moveTooltip(event)"
                                onmouseleave="hideTooltip()">
                                <div class="gantt-bar-progress" style="width: ${progress}%"></div>
                                <span class="gantt-bar-label">${task.status}</span>
                        </div>
                    </div>
                </div>`;
                return html;
            }).join('');
        }

        function getProgressFromStatus(status) {
            if (status === 'Done' || status === 'Milestone') return 100;
            if (status === 'In Progress') return 50;
            if (status === 'Photos') return 60;
            if (status === 'Training') return 30;
            if (status === 'HW Rev 1') return 80;
            if (status === 'Firmware') return 20;
            if (status === 'App Dev') return 30;
            if (status === 'Delayed') return 20;
            if (status === 'Critical') return 10;
            return 0;
        }

        // Modal Logic
        const modal = document.getElementById('task-modal');
        const modalTitle = document.getElementById('modal-title');
        const taskIdInput = document.getElementById('task-id');
        const taskNameInput = document.getElementById('task-name');
        const taskPhaseInput = document.getElementById('task-phase');
        const taskStartInput = document.getElementById('task-start');
        const taskDurationInput = document.getElementById('task-duration');
        const taskStatusInput = document.getElementById('task-status');
        const btnDelete = document.getElementById('btn-delete');

        function openAddModal() {
            modalTitle.innerText = 'Add New Task';
            taskIdInput.value = '';
            taskNameInput.value = '';
            taskPhaseInput.value = '1. INITIATION';
            taskStartInput.value = 1;
            taskDurationInput.value = 2;
            taskStatusInput.value = 'Pending';
            btnDelete.style.display = 'none';
            modal.classList.add('active');
        }

        function openEditModal(data) {
            modalTitle.innerText = 'Edit Task';
            taskIdInput.value = data.id;
            taskNameInput.value = data.task;
            taskPhaseInput.value = data.phase;
            taskStartInput.value = data.start;
            taskDurationInput.value = data.duration;
            taskStatusInput.value = data.status;
            btnDelete.style.display = 'block';
            modal.classList.add('active');
        }

        function closeModal() {
            modal.classList.remove('active');
        }

        function saveTask() {
            const id = taskIdInput.value;
            const phase = taskPhaseInput.value;
            const status = taskStatusInput.value;
            
            // Auto-assign color based on phase OR status
            let color = '#3b82f6'; // Default Blue
            
            // Status overrides Phase
            if (status === 'Critical') color = '#ef4444';
            else if (status === 'Delayed') color = '#f97316';
            else if (status === 'Done') color = '#64748b';
            else {
                // Fallback to Phase Color
                if (phase.includes('POC')) color = '#8b5cf6';
                else if (phase.includes('DEV')) color = '#10b981';
                else if (phase.includes('IND')) color = '#f59e0b';
            }

            const task = {
                task: taskNameInput.value,
                phase: phase,
                start_week: parseInt(taskStartInput.value),
                duration: parseInt(taskDurationInput.value),
                status: status,
                color: color
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/gantt/${id}` : '/api/gantt';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task)
            })
            .then(res => res.json())
            .then(() => {
                closeModal();
                loadGantt();
            });
        }

        function deleteTask() {
            const id = taskIdInput.value;
            if (!id || !confirm('Are you sure you want to delete this task?')) return;

            fetch(`/api/gantt/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(() => {
                closeModal();
                loadGantt();
            });
        }

        // Simulation Functions
        function triggerRisk(type) {
            fetch('/api/simulate-risk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type })
            })
            .then(res => res.json())
            .then(data => {
                // Show toast or alert
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed; bottom: 20px; right: 20px; 
                    background: #1e293b; color: white; padding: 15px 25px; 
                    border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
                    z-index: 1000; animation: slideIn 0.3s ease-out;
                `;
                toast.innerHTML = `<i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 10px;"></i> ${data.message}`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);

                loadGantt(); // Refresh
            });
        }

        function resetPlan() {
            if(!confirm('Reset project to initial state?')) return;
            fetch('/api/reset', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                loadGantt(); // Refresh
            });
        }

        // Toggle Phase Visibility
        function togglePhase(index) {
            const rows = document.querySelectorAll(`.phase-group-${index}`);
            const icon = document.getElementById(`icon-phase-${index}`);
            const header = icon.closest('.phase-header');
            
            header.classList.toggle('collapsed');
            rows.forEach(row => row.classList.toggle('hidden'));
        }

        // Tooltip Logic
        const tooltip = document.getElementById('gantt-tooltip');

        function showTooltip(e, element) {
            const data = element.dataset;
            const statusColor = getStatusColor(data.status);
            tooltip.innerHTML = `
                <div class="gantt-tooltip-header">
                    <i class="fas fa-tasks" style="color: #3b82f6;"></i> ${data.task}
                </div>
                <div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Phase</span> <span class="gantt-tooltip-value">${data.phase}</span></div>
                <div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Timeline</span> <span class="gantt-tooltip-value">W${data.start} â†’ W${data.end}</span></div>
                <div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Status</span> <span class="gantt-tooltip-value" style="color: ${statusColor}">${data.status}</span></div>
                <div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Progress</span> <span class="gantt-tooltip-value">${data.progress}</span></div>
            `;
            tooltip.style.opacity = '1';
            moveTooltip(e);
        }

        function moveTooltip(e) {
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            
            // Boundary check to keep tooltip on screen
            const tooltipRect = tooltip.getBoundingClientRect();
            const finalX = (x + tooltipRect.width > window.innerWidth) ? x - tooltipRect.width - 15 : x;
            const finalY = (y + tooltipRect.height > window.innerHeight) ? y - tooltipRect.height - 15 : y;

            tooltip.style.left = finalX + 'px';
            tooltip.style.top = finalY + 'px';
        }

        function hideTooltip() {
            tooltip.style.opacity = '0';
        }

        function getStatusColor(status) {
            if (status === 'Critical') return '#ef4444';
            if (status === 'Delayed') return '#f97316';
            if (status === 'Done') return '#64748b';
            if (status === 'In Progress') return '#2563eb';
            return '#10b981';
        }
    </script>
  </body>
</html>

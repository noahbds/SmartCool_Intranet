<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Risk Management — SmartCool Pro Intranet"
    />
    <meta name="theme-color" content="#3b82f6" />
    <title>Risk Management | SmartCool Pro</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/risks.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
  </head>
  <body>
    <script src="js/sidebar.js"></script>
    <script>
      window.si =
        window.si ||
        function () {
          (window.siq = window.siq || []).push(arguments);
        };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
    <main class="main-content">
      <header>
        <h1>
          <i
            class="fas fa-shield-alt"
            style="color: var(--accent); margin-right: 10px"
          ></i>
          Risk Management
        </h1>
        <p>
          Identification, assessment and mitigation of critical Smart Fridge project risks.
        </p>
      </header>

      <section class="risk-legend" id="risk-summary">
        <!-- summary injected by JS -->
      </section>

      <div id="risks-container" class="risks-grid">
        <!-- Risk cards injected by JS -->
      </div>
    </main>
    <script>
      function normalizeLevel(value) {
        if (typeof value === "number") return value;
        if (!value) return 0;
        const v = String(value).toLowerCase();
        if (v.startsWith("high")) return 5;
        if (v.startsWith("med")) return 3;
        if (v.startsWith("low")) return 1;
        const parsed = parseInt(v, 10);
        return Number.isFinite(parsed) ? parsed : 0;
      }

      function severityClass(score) {
        if (score >= 16) return "high";
        if (score >= 9) return "medium";
        return "low";
      }

      function createEl(tag, className, text) {
        const el = document.createElement(tag);
        if (className) el.className = className;
        if (text !== undefined) el.textContent = text;
        return el;
      }

      function renderSummary(risks) {
        const summary = document.getElementById("risk-summary");
        const total = risks.length;
        const high = risks.filter((r) => r.severity === "high").length;
        const medium = risks.filter((r) => r.severity === "medium").length;
        const low = risks.filter((r) => r.severity === "low").length;
        const top3 = risks
          .slice(0, 3)
          .map((r) => `${r.name} (RPN ${r.score})`)
          .join(" · ");

        summary.innerHTML = "";

        const cards = [
          {
            title: "Cumulative RPN",
            value: risks.reduce((s, r) => s + r.score, 0),
            icon: "fa-calculator",
          },
          { title: "Top 3 Risks", value: top3 || "N/A", icon: "fa-list-ol" },
          {
            title: "Thresholds",
            value: `${high} high · ${medium} medium · ${low} low (of ${total})`,
            icon: "fa-traffic-light",
          },
        ];

        cards.forEach((c) => {
          const card = createEl("div", "legend-card");
          const title = createEl("div", "legend-title");
          const icon = createEl("i", `fas ${c.icon}`);
          title.append(icon, createEl("span", null, c.title));
          const value = createEl("div");
          value.textContent = c.value;
          card.append(title, value);
          summary.appendChild(card);
        });

        const legend = createEl("div", "legend-card");
        const lTitle = createEl("div", "legend-title");
        lTitle.append(
          createEl("i", "fas fa-chart-area"),
          createEl("span", null, "Probability x Impact Grid (1-5)")
        );
        const pills = createEl("div");
        pills.append(
          createEl("span", "pill red", ">=16 Critical"),
          createEl("span", "pill amber", "9-15 Major"),
          createEl("span", "pill green", "<9 Moderate")
        );
        legend.append(lTitle, pills);
        summary.appendChild(legend);
      }

      async function loadRiskCards() {
        try {
          const resp = await fetch("/api/risks");
          const risksRaw = await resp.json();

          if (!Array.isArray(risksRaw) || risksRaw.length === 0) {
            document.getElementById("risks-container").innerHTML =
              "<p>No risks available.</p>";
            return;
          }

          const normalized = risksRaw
            .map((r) => {
              const prob = normalizeLevel(
                r.probability ?? r.prob ?? r.likelihood
              );
              const impact = normalizeLevel(r.impact);
              const score = prob * impact;
              const severity = severityClass(score);
              return {
                ...r,
                probability: prob,
                impact,
                score,
                severity,
                name: r.name || r.title || "Unnamed",
                description: r.description || r.context || "N/A",
              };
            })
            .sort((a, b) => b.score - a.score);

          renderSummary(normalized);

          const container = document.getElementById("risks-container");
          container.innerHTML = "";

          normalized.forEach((risk, idx) => {
            const card = createEl("div", `risk-card ${risk.severity}`);
            card.id = `risk-${idx}`;

            const header = createEl("div", "risk-header");
            const iconWrap = createEl(
              "div",
              "risk-icon",
              risk.severity === "high"
                ? "warning"
                : risk.severity === "medium"
                ? "flash_on"
                : "info"
            );
            const hBlock = createEl("div");
            hBlock.append(createEl("h3", "risk-title", risk.name));
            const badges = createEl("div", "risk-badges");
            badges.append(
              createEl(
                "span",
                "risk-badge prob",
                `Prob: ${risk.probability}/5`
              ),
              createEl("span", "risk-badge impact", `Impact: ${risk.impact}/5`),
              createEl("span", "risk-badge score", `RPN: ${risk.score}`),
              createEl("span", "risk-badge owner", risk.owner || "N/A")
            );
            hBlock.appendChild(badges);
            header.append(iconWrap, hBlock);

            const content = createEl("div", "risk-content");
            const fields = [
              ["Domain", risk.category || "N/A"],
              ["Description", risk.description],
              ["Trigger", risk.trigger || "N/A"],
              ["Fallback", risk.fallback || "N/A"],
              ["Status", risk.status || "N/A"],
            ];
            fields.forEach(([label, value]) => {
              const row = createEl("div", "risk-field");
              row.append(
                createEl("div", "risk-field-label", `${label}:`),
                createEl("div", "risk-field-value", value)
              );
              content.appendChild(row);
            });

            const mitigation = createEl("div", "risk-mitigation");
            mitigation.append(
              createEl("strong", null, "Mitigation:"),
              createEl("div", null, risk.mitigation || "N/A")
            );

            card.append(header, content, mitigation);
            container.appendChild(card);
          });
        } catch (err) {
          console.error("Error loading risks:", err);
        }
      }

      window.addEventListener("load", loadRiskCards);
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Gestion des Risques — SmartCool Pro Intranet"
    />
    <meta name="theme-color" content="#3b82f6" />
    <title>Gestion des Risques | SmartCool Pro</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .risk-card {
        border-left: 6px solid;
        border-radius: 8px;
        padding: 20px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 16px;
      }
      .risk-card.high {
        border-left-color: #ef4444;
        background: #fef2f2;
      }
      .risk-card.medium {
        border-left-color: #f59e0b;
        background: #fffbeb;
      }
      .risk-card.low {
        border-left-color: #10b981;
        background: #f0fdf4;
      }
      .risk-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .risk-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
      }
      .risk-card.high .risk-icon {
        background: #fee2e2;
        color: #991b1b;
      }
      .risk-card.medium .risk-icon {
        background: #fef3c7;
        color: #92400e;
      }
      .risk-card.low .risk-icon {
        background: #dcfce7;
        color: #166534;
      }
      .risk-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #0f172a;
        margin: 0;
      }
      .risk-badges {
        display: flex;
        gap: 8px;
      }
      .risk-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
      }
      .risk-badge.prob {
        background: #dbeafe;
        color: #1e40af;
      }
      .risk-badge.impact {
        background: #fee2e2;
        color: #991b1b;
      }
      .risk-content {
        margin-bottom: 12px;
      }
      .risk-field {
        display: flex;
        gap: 12px;
        margin-bottom: 8px;
      }
      .risk-field-label {
        font-weight: 600;
        color: #475569;
        min-width: 100px;
        font-size: 0.9rem;
      }
      .risk-field-value {
        color: #0f172a;
        font-size: 0.9rem;
      }
      .risk-mitigation {
        background: rgba(255, 255, 255, 0.5);
        border-left: 2px solid currentColor;
        padding: 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #334155;
        margin-top: 12px;
      }
    </style>
  </head>
  <body>
    <script src="js/sidebar.js"></script>
    <script>
      window.si =
        window.si ||
        function () {
          (window.siq = window.siq || []).push(arguments);
        };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
    <main class="main-content">
      <header>
        <h1>
          <i
            class="fas fa-shield-alt"
            style="color: var(--accent); margin-right: 10px"
          ></i>
          Gestion des Risques
        </h1>
        <p>Identification, évaluation et atténuation des risques critiques du projet.</p>
      </header>

      <div id="risks-container" style="display: grid; gap: 16px;">
        <!-- Risk cards injected by JS -->
      </div>

    </main>
    <script>
      async function loadRiskCards() {
        try {
          const resp = await fetch('/api/risks');
          const risks = await resp.json();
          
          if (!risks || risks.length === 0) {
            console.log('No risks available');
            return;
          }

          const container = document.getElementById('risks-container');
          container.innerHTML = '';
          
          // Sort by impact score and show all
          const sorted = risks
            .map(r => ({
              ...r,
              score: (r.probability || 0) * (r.impact || 0)
            }))
            .sort((a, b) => b.score - a.score);

          sorted.forEach((risk, idx) => {
            const severity = risk.impact >= 4 ? 'high' : risk.impact >= 3 ? 'medium' : 'low';
            const icon = severity === 'high' ? '⚠️' : severity === 'medium' ? '⚡' : 'ℹ️';
            
            const html = `
              <div class="risk-card ${severity}" id="risk-${idx}">
                <div class="risk-header">
                  <div class="risk-icon">${icon}</div>
                  <div>
                    <h3 class="risk-title">${risk.name || 'Sans nom'}</h3>
                    <div class="risk-badges">
                      <span class="risk-badge prob">Prob: ${risk.probability || 0}/5</span>
                      <span class="risk-badge impact">Impact: ${risk.impact || 0}/5</span>
                    </div>
                  </div>
                </div>
                <div class="risk-content">
                  <div class="risk-field">
                    <div class="risk-field-label">Domaine:</div>
                    <div class="risk-field-value">${risk.category || 'N/A'}</div>
                  </div>
                  <div class="risk-field">
                    <div class="risk-field-label">Responsable:</div>
                    <div class="risk-field-value">${risk.owner || 'N/A'}</div>
                  </div>
                  <div class="risk-field">
                    <div class="risk-field-label">Description:</div>
                    <div class="risk-field-value">${risk.description || 'N/A'}</div>
                  </div>
                  <div class="risk-mitigation">
                    <strong>Atténuation:</strong><br/>
                    ${risk.mitigation || 'N/A'}
                  </div>
                </div>
              </div>
            `;
            container.innerHTML += html;
          });

        } catch (err) {
          console.error('Error loading risks:', err);
        }
      }

      // Load on page load
      window.addEventListener('load', loadRiskCards);
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Risks | SmartCool Pro</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .risk-card {
        border-left: 6px solid;
        border-radius: 8px;
        padding: 20px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 16px;
        transition: transform 0.2s;
      }
      .risk-card:hover {
        transform: translateX(5px);
      }
      .risk-card.High { border-left-color: #ef4444; background: #fff5f5; }
      .risk-card.Medium { border-left-color: #f59e0b; background: #fffaf0; }
      .risk-card.Low { border-left-color: #10b981; background: #f0fdf4; }

      .risk-header {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        margin-bottom: 12px;
      }
      .risk-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: rgba(0,0,0,0.05);
      }
      .risk-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #0f172a;
        margin: 0 0 5px 0;
      }
      .risk-badges {
        display: flex;
        gap: 8px;
      }
      .risk-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .risk-badge.prob { background: #e2e8f0; color: #475569; }
      .risk-badge.impact { background: #fee2e2; color: #991b1b; }
      
      .risk-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 12px;
        font-size: 0.9rem;
        color: #334155;
      }
      .detail-item strong { color: #1e293b; display: block; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
      
      .mitigation-box {
        margin-top: 15px;
        padding: 12px;
        background: rgba(255,255,255,0.6);
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 6px;
        font-size: 0.9rem;
      }
      .mitigation-box i { color: #10b981; margin-right: 6px; }
    </style>
  </head>
  <body>
    <script src="js/sidebar.js"></script>
    <main class="main-content">
      <header>
        <h1><i class="fas fa-shield-alt header-icon"></i>Gestion des Risques</h1>
        <p>Identification et mitigation des menaces critiques (Règles §7).</p>
      </header>

      <div id="loading" style="text-align: center; padding: 40px; color: #64748b;">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br>Chargement des risques...
      </div>

      <div id="risks-container"></div>
    </main>

    <script>
      const scoreMap = { 'High': 5, 'Medium': 3, 'Low': 1 };

      async function loadRisks() {
        try {
          const res = await fetch('/api/risks');
          const data = await res.json();
          const container = document.getElementById('risks-container');
          
          // Sort by severity (Impact * Prob)
          const sortedRisks = data.sort((a, b) => {
            const scoreA = (scoreMap[a.impact] || 0) + (scoreMap[a.prob] || 0);
            const scoreB = (scoreMap[b.impact] || 0) + (scoreMap[b.prob] || 0);
            return scoreB - scoreA;
          });

          container.innerHTML = sortedRisks.map(risk => {
            // Mapping values for display
            const probScore = scoreMap[risk.prob] || '?';
            const impactScore = scoreMap[risk.impact] || '?';
            
            return `
              <div class="risk-card ${risk.impact}">
                <div class="risk-header">
                  <div class="risk-icon" style="color: ${risk.color}">
                    <i class="fas ${risk.icon || 'fa-exclamation-triangle'}"></i>
                  </div>
                  <div style="flex: 1;">
                    <h3 class="risk-title">${risk.title}</h3>
                    <div class="risk-badges">
                      <span class="risk-badge prob">Prob: ${risk.prob} (${probScore}/5)</span>
                      <span class="risk-badge impact">Impact: ${risk.impact} (${impactScore}/5)</span>
                    </div>
                  </div>
                </div>
                
                <div class="risk-details">
                  <div class="detail-item">
                    <strong>Contexte / Cause</strong>
                    ${risk.context}
                  </div>
                  <div class="detail-item">
                    <strong>Catégorie</strong>
                    <span style="display:inline-block; padding:2px 6px; background:#f1f5f9; border-radius:4px;">${risk.category}</span>
                  </div>
                  <div class="detail-item">
                    <strong>Responsable</strong>
                    ${risk.owner}
                  </div>
                </div>

                <div class="mitigation-box">
                  <strong><i class="fas fa-tools"></i> Plan d'Atténuation:</strong><br>
                  ${risk.mitigation}
                </div>
              </div>
            `;
          }).join('');
          
          document.getElementById('loading').style.display = 'none';
        } catch (e) {
          console.error(e);
          document.getElementById('loading').innerHTML = `<span style="color:red">Erreur de chargement: ${e.message}</span>`;
        }
      }

      loadRisks();
    </script>
  </body>
</html>
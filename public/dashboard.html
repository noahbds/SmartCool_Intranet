<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | SmartCool Pro</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .kpi-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .kpi-info h3 { margin: 0; font-size: 0.9rem; color: #64748b; }
        .kpi-info p { margin: 5px 0 0; font-size: 1.5rem; font-weight: bold; color: #1e293b; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .workload-item { margin-bottom: 15px; }
        .workload-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .workload-bar-bg { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; }
        .workload-bar-fill { height: 100%; border-radius: 4px; }
    </style>
</head>
<body>
    <script src="js/sidebar.js"></script>
    <script>
      window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
    <main class="main-content">
        <header>
            <h1>Project Dashboard</h1>
            <p>Real-time overview of T-CEN-500 Industrialization.</p>
        </header>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon" style="background: #dbeafe; color: #2563eb;"><i class="fas fa-wallet"></i></div>
                <div class="kpi-info">
                    <h3>Total Budget</h3>
                    <p id="kpi-budget">Loading...</p>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon" style="background: #dcfce7; color: #166534;"><i class="fas fa-chart-line"></i></div>
                <div class="kpi-info">
                    <h3>Progress</h3>
                    <p id="kpi-progress">0%</p>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon" style="background: #fee2e2; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="kpi-info">
                    <h3>Active Risks</h3>
                    <p id="kpi-risks">0</p>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon" style="background: #f3e8ff; color: #9333ea;"><i class="fas fa-users"></i></div>
                <div class="kpi-info">
                    <h3>Team Size</h3>
                    <p>7</p>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Left Column -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Timeline / Status -->
                <div class="card">
                    <h2><i class="fas fa-clock"></i> Project Timeline</h2>
                    <div style="display: flex; align-items: center; gap: 30px; margin-top: 20px;">
                        <div style="position: relative; width: 100px; height: 100px;">
                            <svg width="100" height="100" viewBox="0 0 36 36">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e2e8f0" stroke-width="3" />
                                <path id="progress-circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#2563eb" stroke-width="3" />
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 1.2rem;" id="percent-display">0%</div>
                        </div>
                        <div>
                            <h3 id="week-display" style="margin: 0; font-size: 1.2rem;">Week 1</h3>
                            <p style="color: #64748b; margin-top: 5px;">On track for Q2 Delivery</p>
                        </div>
                    </div>
                </div>

                <!-- Budget Detail -->
                <div class="card">
                    <h2><i class="fas fa-coins"></i> Budget Utilization</h2>
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Spent: $34,500</span>
                            <span id="budget-total-display">Total: $0</span>
                        </div>
                        <div style="width: 100%; background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden;">
                            <div id="budget-bar" style="width: 0%; background: #2563eb; height: 100%; transition: width 1s;"></div>
                        </div>
                        <div style="display: flex; gap: 20px; margin-top: 15px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 10px; height: 10px; background: #2563eb; border-radius: 50%;"></div>
                                <span style="font-size: 0.9rem; color: #64748b;">CAPEX (40%)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 10px; height: 10px; background: #e2e8f0; border-radius: 50%;"></div>
                                <span style="font-size: 0.9rem; color: #64748b;">Remaining</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Team Workload -->
                <div class="card">
                    <h2><i class="fas fa-tasks"></i> Resource Load</h2>
                    <div style="margin-top: 20px;">
                        <!-- Hardcoded based on Gantt -->
                        <div class="workload-item">
                            <div class="workload-header"><span>Sophie (HW)</span><span>85%</span></div>
                            <div class="workload-bar-bg"><div class="workload-bar-fill" style="width: 85%; background: #ef4444;"></div></div>
                        </div>
                        <div class="workload-item">
                            <div class="workload-header"><span>Emma (AI)</span><span>90%</span></div>
                            <div class="workload-bar-bg"><div class="workload-bar-fill" style="width: 90%; background: #ef4444;"></div></div>
                        </div>
                        <div class="workload-item">
                            <div class="workload-header"><span>Jean (PM)</span><span>60%</span></div>
                            <div class="workload-bar-bg"><div class="workload-bar-fill" style="width: 60%; background: #f59e0b;"></div></div>
                        </div>
                        <div class="workload-item">
                            <div class="workload-header"><span>Lucas (Cloud)</span><span>40%</span></div>
                            <div class="workload-bar-bg"><div class="workload-bar-fill" style="width: 40%; background: #10b981;"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Milestones -->
                <div class="card">
                    <h2><i class="fas fa-flag"></i> Next Milestones</h2>
                    <ul id="milestones-list" style="list-style: none; padding: 0; margin-top: 15px;">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/dashboard')
                .then(res => res.json())
                .then(data => {
                    // Budget
                    const total = data.totalBudget;
                    const spent = 34500; // Demo value
                    const percent = Math.min(100, (spent / total) * 100).toFixed(1);
                    
                    document.getElementById('kpi-budget').innerText = '$' + (total / 1000).toFixed(1) + 'k';
                    document.getElementById('budget-total-display').innerText = 'Total: $' + total.toLocaleString();
                    document.getElementById('budget-bar').style.width = percent + '%';

                    // Risks
                    document.getElementById('kpi-risks').innerText = data.risks.length;

                    // Progress
                    const startDate = new Date(data.projectStart);
                    const today = new Date();
                    const diffTime = Math.abs(today - startDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const currentWeek = Math.ceil(diffDays / 7);
                    const totalWeeks = 24;
                    const progressPercent = Math.min(100, Math.max(0, (currentWeek / totalWeeks) * 100)).toFixed(0);

                    document.getElementById('kpi-progress').innerText = progressPercent + '%';
                    document.getElementById('percent-display').innerText = progressPercent + '%';
                    document.getElementById('week-display').innerText = `Week ${currentWeek}`;
                    
                    setTimeout(() => {
                        document.getElementById('progress-circle').setAttribute('stroke-dasharray', `${progressPercent}, 100`);
                    }, 100);

                    // Milestones
                    const mList = document.getElementById('milestones-list');
                    mList.innerHTML = data.milestones.slice(0, 4).map(m => `
                        <li style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9;">
                            <div>
                                <div style="font-weight: 500;">${m.name}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${m.date}</div>
                            </div>
                            <span style="font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; background: ${m.status === 'Done' ? '#dcfce7' : '#fef3c7'}; color: ${m.status === 'Done' ? '#166534' : '#b45309'}; height: fit-content;">
                                ${m.status}
                            </span>
                        </li>
                    `).join('');
                });
        });
    </script>
</body>
</html>

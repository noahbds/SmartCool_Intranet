<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Budget & Resources ‚Äî SmartCool Pro Intranet"
    />
    <meta name="theme-color" content="#3b82f6" />
    <title>Budget | SmartCool Pro</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .pie-chart {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(#cbd5e1 0% 50%, #e2e8f0 50% 100%);
        margin: 0 auto 20px auto;
        position: relative;
      }
      .pie-chart::after {
        content: "";
        position: absolute;
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 50%;
        top: 20px;
        left: 20px;
      }
      /* Styles from ddd/budget.html */
      .sheet-wrapper {
        overflow-x: auto;
        background: white;
        border: 1px solid #e0e0e0;
        margin-top: 20px;
      }
      .google-sheet-style {
        border-collapse: collapse;
        width: 100%;
        font-family: arial, sans-serif;
        font-size: 13px;
      }
      .google-sheet-style th {
        background-color: #f8f9fa;
        border: 1px solid #e0e0e0;
        padding: 8px;
        text-align: left;
        color: #5f6368;
        font-weight: bold;
        position: sticky;
        top: 0;
      }
      .google-sheet-style td {
        border: 1px solid #e0e0e0;
        padding: 6px 8px;
        color: #000;
      }
      .google-sheet-style tr:nth-child(even) {
        background-color: #ffffff;
      }
      .google-sheet-style .row-num {
        background-color: #f8f9fa;
        text-align: center;
        color: #5f6368;
        font-weight: bold;
        width: 30px;
      }
      .download-btn {
        display: inline-block;
        background: #27ae60;
        color: white;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 5px;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .download-btn:hover {
        background: #219150;
      }
    </style>
  </head>
  <body>
    <script src="js/sidebar.js"></script>
    <script>
      window.si =
        window.si ||
        function () {
          (window.siq = window.siq || []).push(arguments);
        };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
    <main class="main-content">
      <header>
        <h1>
          <i
            class="fas fa-coins"
            style="color: var(--accent); margin-right: 10px"
          ></i
          >Budget & Resources
        </h1>
        <p>Financial planning for Prototype and Industrialization phases.</p>
      </header>

      <div
        style="
          display: grid;
          grid-template-columns: 3fr 1fr;
          gap: 24px;
          margin-bottom: 32px;
        "
      >
        <div
          class="card-grid"
          style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"
          id="budget-cards"
        >
          <!-- Cards injected by JS -->
        </div>

        <!-- Visual Chart -->
        <div
          class="card"
          style="
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
          "
        >
          <div class="pie-chart"></div>
          <div style="font-size: 0.8rem; color: var(--text-muted)">
            <span style="color: var(--accent)">‚óè</span>
            CAPEX (<span id="capex-percent">--</span>%) <br />
            <span style="color: #10b981">‚óè</span>
            OPEX (<span id="opex-percent">--</span>%)
          </div>
        </div>
      </div>

      <h2>
        <i class="fas fa-list-ul"></i> Bill of Materials (BOM) - Key Components
      </h2>
      <div class="table-container" style="margin-bottom: 40px">
        <table>
          <thead>
            <tr>
              <th>Component</th>
              <th>Description</th>
              <th>Unit Cost (Est.)</th>
              <th>Supplier</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="bom-body">
            <!-- BOM injected by JS -->
          </tbody>
        </table>
      </div>

      <h2>R√©partition Budg√©taire D√©taill√©e</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Cat√©gorie</th>
              <th>√âl√©ment</th>
              <th>Fournisseur</th>
              <th>Co√ªt Unitaire (‚Ç¨)</th>
              <th>Quantit√©</th>
              <th>Total (‚Ç¨)</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="detailed-budget-body">
            <!-- Budget items injected by JS -->
          </tbody>
        </table>
      </div>

      <h2 style="margin-top: 40px; margin-bottom: 20px;">Budget D√©taill√© & Financier</h2>
      <a href="spreadsheets/SmartCool_Budget_Detaille.csv" class="download-btn"
        >üì• T√©l√©charger le CSV (Compatible Excel/Sheets)</a
      >
      <div class="sheet-container">
        <table class="google-sheet-style">
          <thead>
            <tr>
              <th>#</th>
              <th>CATEGORIE</th>
              <th>SOUS-CATEGORIE</th>
              <th>ELEMENT</th>
              <th>FOURNISSEUR</th>
              <th>COUT UNITAIRE (‚Ç¨)</th>
              <th>QUANTITE / MOIS</th>
              <th>TOTAL (‚Ç¨)</th>
              <th>NOTES</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="row-num">1</td>
              <td>BOM (Mat√©riel)</td>
              <td>Calcul</td>
              <td>Compute Module 5 (CM5) 4GB</td>
              <td>Raspberry Pi Ltd</td>
              <td>55.00</td>
              <td>1</td>
              <td>55.00</td>
              <td>Prix volume OEM >1k</td>
            </tr>
            <tr>
              <td class="row-num">2</td>
              <td>BOM (Mat√©riel)</td>
              <td>Calcul</td>
              <td>Dissipateur Thermique Passif</td>
              <td>Local Metal</td>
              <td>1.20</td>
              <td>1</td>
              <td>1.20</td>
              <td>Aluminium extrud√© custom</td>
            </tr>
            <tr>
              <td class="row-num">3</td>
              <td>BOM (Mat√©riel)</td>
              <td>Vision</td>
              <td>Module Cam√©ra IMX219 (Wide)</td>
              <td>Arducam</td>
              <td>8.50</td>
              <td>3</td>
              <td>25.50</td>
              <td>3 angles de vue (Haut, Milieu, Bas)</td>
            </tr>
            <tr>
              <td class="row-num">4</td>
              <td>BOM (Mat√©riel)</td>
              <td>Vision</td>
              <td>Nappe FFC (C√¢ble plat)</td>
              <td>Molex</td>
              <td>0.45</td>
              <td>3</td>
              <td>1.35</td>
              <td>Blindage EMI requis</td>
            </tr>
            <tr>
              <td class="row-num">5</td>
              <td>BOM (Mat√©riel)</td>
              <td>PCB</td>
              <td>Carte M√®re Custom (Carrier Board)</td>
              <td>JLCPCB / PCBWay</td>
              <td>12.00</td>
              <td>1</td>
              <td>12.00</td>
              <td>4 couches, ENIG finish</td>
            </tr>
            <tr>
              <td class="row-num">6</td>
              <td>BOM (Mat√©riel)</td>
              <td>PCB</td>
              <td>Microcontr√¥leur (Gestion temps r√©el)</td>
              <td>STM32G030</td>
              <td>1.80</td>
              <td>1</td>
              <td>1.80</td>
              <td>Gestion capteurs portes & LED</td>
            </tr>
            <tr>
              <td class="row-num">7</td>
              <td>BOM (Mat√©riel)</td>
              <td>Capteurs</td>
              <td>Capteur Temp/Humidit√© (I2C)</td>
              <td>Sensirion SHT40</td>
              <td>2.10</td>
              <td>1</td>
              <td>2.10</td>
              <td>Pr√©cision +/- 0.2C</td>
            </tr>
            <tr>
              <td class="row-num">8</td>
              <td>BOM (Mat√©riel)</td>
              <td>Capteurs</td>
              <td>Capteur Portes (Reed Switch)</td>
              <td>DigiKey</td>
              <td>0.60</td>
              <td>2</td>
              <td>1.20</td>
              <td>D√©tection ouverture</td>
            </tr>
            <tr>
              <td class="row-num">9</td>
              <td>BOM (Mat√©riel)</td>
              <td>Interface</td>
              <td>√âcran LCD 7 pouces Touch</td>
              <td>BOE / Tianma</td>
              <td>35.00</td>
              <td>1</td>
              <td>35.00</td>
              <td>Interface utilisateur externe</td>
            </tr>
            <tr>
              <td class="row-num">10</td>
              <td>BOM (Mat√©riel)</td>
              <td>Alim</td>
              <td>Convertisseur AC/DC 5V 5A</td>
              <td>Mean Well</td>
              <td>14.50</td>
              <td>1</td>
              <td>14.50</td>
              <td>Certifi√© CE/UL de qualit√© industrielle</td>
            </tr>
            <tr>
              <td class="row-num">11</td>
              <td>BOM (Mat√©riel)</td>
              <td>Boitier</td>
              <td>Injection Plastique (ABS)</td>
              <td>Usine Partenaire</td>
              <td>18.00</td>
              <td>1</td>
              <td>18.00</td>
              <td>Moule 2 cavit√©s</td>
            </tr>
            <tr>
              <td class="row-num">12</td>
              <td>BOM (Mat√©riel)</td>
              <td>Divers</td>
              <td>Visserie & Assemblage</td>
              <td>-</td>
              <td>2.00</td>
              <td>1</td>
              <td>2.00</td>
              <td></td>
            </tr>
            <tr>
              <td class="row-num">13</td>
              <td></td>
              <td></td>
              <td>SOUS-TOTAL BOM (par unit√©)</td>
              <td></td>
              <td></td>
              <td></td>
              <td>169.65</td>
              <td>Marge brute vis√©e: 40%</td>
            </tr>
            <tr>
              <td class="row-num">14</td>
              <td>CAPEX (One-off)</td>
              <td>Outillage</td>
              <td>Moule Injection Acier (Chassis)</td>
              <td>Foxconn Molding</td>
              <td>45000.00</td>
              <td>1</td>
              <td>45000.00</td>
              <td>Dur√©e de vie: 500k cycles</td>
            </tr>
            <tr>
              <td class="row-num">15</td>
              <td>CAPEX (One-off)</td>
              <td>Outillage</td>
              <td>Moule Injection (Support Cam√©ra)</td>
              <td>Foxconn Molding</td>
              <td>12000.00</td>
              <td>1</td>
              <td>12000.00</td>
              <td>Pr√©cision optique requise</td>
            </tr>
            <tr>
              <td class="row-num">16</td>
              <td>CAPEX (One-off)</td>
              <td>R&D</td>
              <td>Banc de Test (Calibration Cam√©ra)</td>
              <td>Interne</td>
              <td>8500.00</td>
              <td>1</td>
              <td>8500.00</td>
              <td>Mire de calibration automatis√©e</td>
            </tr>
            <tr>
              <td class="row-num">17</td>
              <td>CAPEX (One-off)</td>
              <td>L√©gal</td>
              <td>Certification CE/RED (Europe)</td>
              <td>TUV Rheinland</td>
              <td>15000.00</td>
              <td>1</td>
              <td>15000.00</td>
              <td>Test EMC et Radio</td>
            </tr>
            <tr>
              <td class="row-num">18</td>
              <td>CAPEX (One-off)</td>
              <td>L√©gal</td>
              <td>Certification FCC (USA)</td>
              <td>SGS Labs</td>
              <td>18000.00</td>
              <td>1</td>
              <td>18000.00</td>
              <td>Part 15 Class B</td>
            </tr>
            <tr>
              <td class="row-num">19</td>
              <td></td>
              <td></td>
              <td>SOUS-TOTAL CAPEX</td>
              <td></td>
              <td></td>
              <td></td>
              <td>98500.00</td>
              <td></td>
            </tr>
            <tr>
              <td class="row-num">20</td>
              <td>OPEX (Mensuel)</td>
              <td>RH</td>
              <td>Lead Developer (Embedded)</td>
              <td>Interne</td>
              <td>6500.00</td>
              <td>6</td>
              <td>39000.00</td>
              <td>Salaire charg√© (France)</td>
            </tr>
            <tr>
              <td class="row-num">21</td>
              <td>OPEX (Mensuel)</td>
              <td>RH</td>
              <td>Data Scientist (Computer Vision)</td>
              <td>Freelance</td>
              <td>800.00 (TJM)</td>
              <td>80 (jours)</td>
              <td>64000.00</td>
              <td>Expert Senior</td>
            </tr>
            <tr>
              <td class="row-num">22</td>
              <td>OPEX (Mensuel)</td>
              <td>RH</td>
              <td>Chef de Projet</td>
              <td>Interne</td>
              <td>5800.00</td>
              <td>6</td>
              <td>34800.00</td>
              <td>Salaire charg√©</td>
            </tr>
            <tr>
              <td class="row-num">23</td>
              <td>OPEX (Mensuel)</td>
              <td>Cloud</td>
              <td>AWS IoT Core (MQTT)</td>
              <td>Amazon AWS</td>
              <td>0.05 (par device)</td>
              <td>100</td>
              <td>30.00</td>
              <td>Dev environment</td>
            </tr>
            <tr>
              <td class="row-num">24</td>
              <td>OPEX (Mensuel)</td>
              <td>Cloud</td>
              <td>Stockage S3 (Images Dataset)</td>
              <td>Amazon AWS</td>
              <td>0.023 (par GB)</td>
              <td>5000</td>
              <td>115.00</td>
              <td>Training data</td>
            </tr>
            <tr>
              <td class="row-num">25</td>
              <td>OPEX (Mensuel)</td>
              <td>Bureaux</td>
              <td>Location Labo √âlectronique</td>
              <td>WeWork/Labs</td>
              <td>2500.00</td>
              <td>6</td>
              <td>15000.00</td>
              <td>Paris Intra-muros</td>
            </tr>
            <tr>
              <td class="row-num">26</td>
              <td></td>
              <td></td>
              <td>SOUS-TOTAL OPEX (6 Mois)</td>
              <td></td>
              <td></td>
              <td></td>
              <td>152945.00</td>
              <td></td>
            </tr>
            <tr>
              <td class="row-num">27</td>
              <td></td>
              <td></td>
              <td>TOTAL GENERAL PROJET</td>
              <td></td>
              <td></td>
              <td></td>
              <td>251614.65</td>
              <td>Besoin de financement</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
    <script>
      fetch("/api/budget")
        .then((res) => res.json())
        .then((data) => {
          // Render Budget Cards
          const cardsContainer = document.getElementById("budget-cards");
          const total = data.summary.find((s) => s.category === "Total").amount;
          const capex = data.summary.find((s) => s.category === "CAPEX").amount;
          const opex = data.summary.find((s) => s.category === "OPEX").amount;

            cardsContainer.innerHTML = `
                <div class="card">
                  <h3>Budget Total</h3>
                  <p class="counter" data-target="${total}" style="font-size: 2rem; font-weight: 700; color: var(--primary); margin: 10px 0;">‚Ç¨0</p>
                  <p style="color: var(--text-muted);"><i class="fas fa-check-circle"></i> Approuv√© par le Conseil</p>
                </div>
                <div class="card">
                  <h3>CAPEX (One-time)</h3>
                  <p class="counter" data-target="${capex}" style="font-size: 2rem; font-weight: 700; color: var(--accent); margin: 10px 0;">‚Ç¨0</p>
                  <p style="color: var(--text-muted);">Outillage, Moules</p>
                </div>
                <div class="card">
                  <h3>OPEX (R√©current)</h3>
                  <p class="counter" data-target="${opex}" style="font-size: 2rem; font-weight: 700; color: #10b981; margin: 10px 0;">‚Ç¨0</p>
                  <p style="color: var(--text-muted);">RH, Cloud, BOM</p>
                </div>
              `;

            // Update pie chart with live ratios
            const pie = document.querySelector('.pie-chart');
            const capexPct = Math.round((capex / total) * 100);
            const opexPct = 100 - capexPct;
            pie.style.background = `conic-gradient(var(--accent) 0% ${capexPct}%, #10b981 ${capexPct}% 100%)`;
            document.getElementById('capex-percent').innerText = capexPct;
            document.getElementById('opex-percent').innerText = opexPct;

          // Render BOM
          const bomBody = document.getElementById("bom-body");
          bomBody.innerHTML = data.bom
            .map(
              (item) => `
                    <tr>
                        <td><i class="fas ${item.icon}"></i> ${
                item.component
              }</td>
                        <td>${item.description}</td>
                        <td>‚Ç¨${item.cost.toFixed(2)}</td>
                        <td>${item.supplier}</td>
                        <td><span class="status-badge ${
                          item.status === "Sourced"
                            ? "status-done"
                            : "status-wip"
                        }">${item.status}</span></td>
                    </tr>
                `
            )
            .join("");

          // Render detailed budget
          const detailedBody = document.getElementById("detailed-budget-body");
          const budgetItems = [
            { category: 'BOM (Mat√©riel)', item: 'Compute Module 5 (CM5) 4GB', supplier: 'Raspberry Pi Ltd', unitCost: 55.00, quantity: 1, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Dissipateur Thermique Passif', supplier: 'Local Metal', unitCost: 1.20, quantity: 1, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Module Cam√©ra IMX219 (Wide)', supplier: 'Arducam', unitCost: 8.50, quantity: 3, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Nappe FFC (C√¢ble plat)', supplier: 'Molex', unitCost: 0.45, quantity: 3, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Carte M√®re Custom (Carrier Board)', supplier: 'JLCPCB / PCBWay', unitCost: 12.00, quantity: 1, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Microcontr√¥leur (Gestion temps r√©el)', supplier: 'STM32G030', unitCost: 1.80, quantity: 1, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Capteur Temp/Humidit√©', supplier: 'Sensirion', unitCost: 2.10, quantity: 1, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Capteur Portes (Reed Switch)', supplier: 'DigiKey', unitCost: 0.60, quantity: 2, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: '√âcran LCD 7 pouces Touch', supplier: 'BOE / Tianma', unitCost: 35.00, quantity: 1, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Convertisseur AC/DC 5V 5A', supplier: 'Mean Well', unitCost: 14.50, quantity: 1, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Injection Plastique (ABS)', supplier: 'Usine Partenaire', unitCost: 18.00, quantity: 1, type: 'OPEX' },
            { category: 'BOM (Mat√©riel)', item: 'Visserie & Assemblage', supplier: '-', unitCost: 2.00, quantity: 1, type: 'OPEX' },
            { category: 'CAPEX (One-off)', item: 'Moule Injection Acier (Chassis)', supplier: 'Foxconn Molding', unitCost: 45000.00, quantity: 1, type: 'CAPEX' },
            { category: 'CAPEX (One-off)', item: 'Moule Injection (Support Cam√©ra)', supplier: 'Foxconn Molding', unitCost: 12000.00, quantity: 1, type: 'CAPEX' },
            { category: 'CAPEX (One-off)', item: 'Banc de Test (Calibration Cam√©ra)', supplier: 'Interne', unitCost: 8500.00, quantity: 1, type: 'CAPEX' },
            { category: 'CAPEX (One-off)', item: 'Certification CE/RED (Europe)', supplier: 'TUV Rheinland', unitCost: 15000.00, quantity: 1, type: 'CAPEX' },
            { category: 'CAPEX (One-off)', item: 'Certification FCC (USA)', supplier: 'SGS Labs', unitCost: 18000.00, quantity: 1, type: 'CAPEX' },
            { category: 'OPEX (Mensuel)', item: 'Lead Developer (Embedded)', supplier: 'Interne', unitCost: 6500.00, quantity: 6, type: 'OPEX' },
            { category: 'OPEX (Mensuel)', item: 'Data Scientist (Computer Vision)', supplier: 'Freelance', unitCost: 800.00, quantity: 80, type: 'OPEX' },
            { category: 'OPEX (Mensuel)', item: 'Chef de Projet', supplier: 'Interne', unitCost: 5800.00, quantity: 6, type: 'OPEX' },
            { category: 'OPEX (Mensuel)', item: 'AWS IoT Core (MQTT)', supplier: 'Amazon AWS', unitCost: 0.05, quantity: 100, type: 'OPEX' },
            { category: 'OPEX (Mensuel)', item: 'Stockage S3 (Images Dataset)', supplier: 'Amazon AWS', unitCost: 0.023, quantity: 5000, type: 'OPEX' },
            { category: 'OPEX (Mensuel)', item: 'Location Labo √âlectronique', supplier: 'WeWork/Labs', unitCost: 2500.00, quantity: 6, type: 'OPEX' },
          ];
          
          detailedBody.innerHTML = budgetItems
            .map(item => {
              const total = (item.unitCost * item.quantity).toFixed(2);
              return `
                <tr>
                  <td>${item.category}</td>
                  <td>${item.item}</td>
                  <td>${item.supplier}</td>
                  <td>‚Ç¨${item.unitCost.toFixed(2)}</td>
                  <td>${item.quantity}</td>
                  <td>‚Ç¨${total}</td>
                  <td><span class="status-badge ${item.type === 'CAPEX' ? 'status-warn' : 'status-info'}">${item.type}</span></td>
                </tr>
              `;
            })
            .join("");

          // Initialize Counters
          initCounters();
        });

      function initCounters() {
        const counters = document.querySelectorAll(".counter");
        counters.forEach((counter) => {
          const target = +counter.getAttribute("data-target");
          const duration = 1500;
          const increment = target / (duration / 16);
          let current = 0;
          const updateCounter = () => {
            current += increment;
            if (current < target) {
              counter.innerText = "‚Ç¨" + Math.ceil(current).toLocaleString('fr-FR');
              requestAnimationFrame(updateCounter);
            } else {
              counter.innerText = "‚Ç¨" + target.toLocaleString('fr-FR');
            }
          };
          updateCounter();
        });
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Budget & Resources — SmartCool Pro Intranet"
    />
    <meta name="theme-color" content="#3b82f6" />
    <title>Budget | SmartCool Pro</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/budget.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body>
    <script src="js/sidebar.js"></script>
    <script>
      window.si =
        window.si ||
        function () {
          (window.siq = window.siq || []).push(arguments);
        };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
    <main class="main-content">
      <header>
        <h1>
          <i
            class="fas fa-coins"
            style="color: var(--accent); margin-right: 10px"
          ></i
          >Budget & Resources
        </h1>
        <p>Financial planning for Prototype and Industrialization phases.</p>
      </header>

      <div
        style="
          display: grid;
          grid-template-columns: 3fr 1fr;
          gap: 24px;
          margin-bottom: 32px;
        "
      >
        <div
          class="card-grid"
          style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"
          id="budget-cards"
        >
          <!-- Cards injected by JS -->
        </div>

        <!-- Visual Chart -->
        <div
          class="card"
          style="
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
          "
        >
          <div class="pie-chart"></div>
          <div style="font-size: 0.8rem; color: var(--text-muted)">
            <span style="color: var(--accent)">●</span>
            CAPEX (<span id="capex-percent">--</span>%) <br />
            <span style="color: #10b981">●</span>
            OPEX (<span id="opex-percent">--</span>%)
          </div>
        </div>
      </div>

      <h2>
        <i class="fas fa-list-ul"></i> Bill of Materials (BOM) - Key Components
      </h2>
      <div class="table-container" style="margin-bottom: 40px">
        <table>
          <thead>
            <tr>
              <th>Component</th>
              <th>Description</th>
              <th>Unit Cost (Est.)</th>
              <th>Supplier</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="bom-body">
            <!-- BOM injected by JS -->
          </tbody>
        </table>
      </div>

      <h2>Répartition Budgétaire Détaillée</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Catégorie</th>
              <th>Élément</th>
              <th>Fournisseur</th>
              <th>Coût Unitaire (€)</th>
              <th>Quantité</th>
              <th>Total (€)</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="detailed-budget-body">
            <!-- Budget items injected by JS -->
          </tbody>
        </table>
      </div>

    </main>
    <script>
      fetch("/api/budget")
        .then((res) => res.json())
        .then((data) => {
          // Render Budget Cards
          const cardsContainer = document.getElementById("budget-cards");
          const total = data.summary?.find((s) => s.category === "Total")?.amount || 0;
          const capex = data.summary?.find((s) => s.category === "CAPEX")?.amount || 0;
          const opex = data.summary?.find((s) => s.category === "OPEX")?.amount || 0;

          cardsContainer.innerHTML = `
                <div class="card">
                  <h3>Budget Total</h3>
                  <p class="counter" data-target="${total}" style="font-size: 2rem; font-weight: 700; color: var(--primary); margin: 10px 0;">€0</p>
                  <p style="color: var(--text-muted);"><i class="fas fa-check-circle"></i> Approuvé par le Conseil</p>
                </div>
                <div class="card">
                  <h3>CAPEX (One-time)</h3>
                  <p class="counter" data-target="${capex}" style="font-size: 2rem; font-weight: 700; color: var(--accent); margin: 10px 0;">€0</p>
                  <p style="color: var(--text-muted);">Outillage, Moules</p>
                </div>
                <div class="card">
                  <h3>OPEX (Récurrent)</h3>
                  <p class="counter" data-target="${opex}" style="font-size: 2rem; font-weight: 700; color: #10b981; margin: 10px 0;">€0</p>
                  <p style="color: var(--text-muted);">RH, Cloud, BOM</p>
                </div>
              `;

          // Update pie chart with live ratios
          const pie = document.querySelector(".pie-chart");
          const capexPct = Math.round((capex / total) * 100);
          const opexPct = 100 - capexPct;
          pie.style.background = `conic-gradient(var(--accent) 0% ${capexPct}%, #10b981 ${capexPct}% 100%)`;
          document.getElementById("capex-percent").innerText = capexPct;
          document.getElementById("opex-percent").innerText = opexPct;

          // Render BOM
          const bomBody = document.getElementById("bom-body");
          bomBody.innerHTML = (data.bom || [])
            .map(
              (item) => `
                    <tr>
                        <td><i class="fas ${item.icon || 'fa-cube'}"></i> ${
                item.component || 'N/A'
              }</td>
                        <td>${item.description || 'N/A'}</td>
                        <td>€${(item.cost || 0).toFixed(2)}</td>
                        <td>${item.supplier || 'N/A'}</td>
                        <td><span class="status-badge ${
                          item.status === "Sourced"
                            ? "status-done"
                            : "status-wip"
                        }">${item.status}</span></td>
                    </tr>
                `
            )
            .join("");

          // Render detailed budget
          const detailedBody = document.getElementById("detailed-budget-body");
          const budgetItems = [
            {
              category: "BOM (Matériel)",
              item: "Compute Module 5 (CM5) 4GB",
              supplier: "Raspberry Pi Ltd",
              unitCost: 55.0,
              quantity: 1,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Dissipateur Thermique Passif",
              supplier: "Local Metal",
              unitCost: 1.2,
              quantity: 1,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Module Caméra IMX219 (Wide)",
              supplier: "Arducam",
              unitCost: 8.5,
              quantity: 3,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Nappe FFC (Câble plat)",
              supplier: "Molex",
              unitCost: 0.45,
              quantity: 3,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Carte Mère Custom (Carrier Board)",
              supplier: "JLCPCB / PCBWay",
              unitCost: 12.0,
              quantity: 1,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Microcontrôleur (Gestion temps réel)",
              supplier: "STM32G030",
              unitCost: 1.8,
              quantity: 1,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Capteur Temp/Humidité",
              supplier: "Sensirion",
              unitCost: 2.1,
              quantity: 1,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Capteur Portes (Reed Switch)",
              supplier: "DigiKey",
              unitCost: 0.6,
              quantity: 2,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Écran LCD 7 pouces Touch",
              supplier: "BOE / Tianma",
              unitCost: 35.0,
              quantity: 1,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Convertisseur AC/DC 5V 5A",
              supplier: "Mean Well",
              unitCost: 14.5,
              quantity: 1,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Injection Plastique (ABS)",
              supplier: "Usine Partenaire",
              unitCost: 18.0,
              quantity: 1,
              type: "OPEX",
            },
            {
              category: "BOM (Matériel)",
              item: "Visserie & Assemblage",
              supplier: "-",
              unitCost: 2.0,
              quantity: 1,
              type: "OPEX",
            },
            {
              category: "CAPEX (One-off)",
              item: "Moule Injection Acier (Chassis)",
              supplier: "Foxconn Molding",
              unitCost: 45000.0,
              quantity: 1,
              type: "CAPEX",
            },
            {
              category: "CAPEX (One-off)",
              item: "Moule Injection (Support Caméra)",
              supplier: "Foxconn Molding",
              unitCost: 12000.0,
              quantity: 1,
              type: "CAPEX",
            },
            {
              category: "CAPEX (One-off)",
              item: "Banc de Test (Calibration Caméra)",
              supplier: "Interne",
              unitCost: 8500.0,
              quantity: 1,
              type: "CAPEX",
            },
            {
              category: "CAPEX (One-off)",
              item: "Certification CE/RED (Europe)",
              supplier: "TUV Rheinland",
              unitCost: 15000.0,
              quantity: 1,
              type: "CAPEX",
            },
            {
              category: "CAPEX (One-off)",
              item: "Certification FCC (USA)",
              supplier: "SGS Labs",
              unitCost: 18000.0,
              quantity: 1,
              type: "CAPEX",
            },
            {
              category: "OPEX (Mensuel)",
              item: "Lead Developer (Embedded)",
              supplier: "Interne",
              unitCost: 6500.0,
              quantity: 6,
              type: "OPEX",
            },
            {
              category: "OPEX (Mensuel)",
              item: "Data Scientist (Computer Vision)",
              supplier: "Freelance",
              unitCost: 800.0,
              quantity: 80,
              type: "OPEX",
            },
            {
              category: "OPEX (Mensuel)",
              item: "Chef de Projet",
              supplier: "Interne",
              unitCost: 5800.0,
              quantity: 6,
              type: "OPEX",
            },
            {
              category: "OPEX (Mensuel)",
              item: "AWS IoT Core (MQTT)",
              supplier: "Amazon AWS",
              unitCost: 0.05,
              quantity: 100,
              type: "OPEX",
            },
            {
              category: "OPEX (Mensuel)",
              item: "Stockage S3 (Images Dataset)",
              supplier: "Amazon AWS",
              unitCost: 0.023,
              quantity: 5000,
              type: "OPEX",
            },
            {
              category: "OPEX (Mensuel)",
              item: "Location Labo Électronique",
              supplier: "WeWork/Labs",
              unitCost: 2500.0,
              quantity: 6,
              type: "OPEX",
            },
          ];

          detailedBody.innerHTML = budgetItems
            .map((item) => {
              const total = (item.unitCost * item.quantity).toFixed(2);
              return `
                <tr>
                  <td>${item.category}</td>
                  <td>${item.item}</td>
                  <td>${item.supplier}</td>
                  <td>€${item.unitCost.toFixed(2)}</td>
                  <td>${item.quantity}</td>
                  <td>€${total}</td>
                  <td><span class="status-badge ${
                    item.type === "CAPEX" ? "status-warn" : "status-info"
                  }">${item.type}</span></td>
                </tr>
              `;
            })
            .join("");

          // Initialize Counters
          initCounters();
        });

      function initCounters() {
        const counters = document.querySelectorAll(".counter");
        counters.forEach((counter) => {
          const target = +counter.getAttribute("data-target");
          const duration = 1500;
          const increment = target / (duration / 16);
          let current = 0;
          const updateCounter = () => {
            current += increment;
            if (current < target) {
              counter.innerText =
                "€" + Math.ceil(current).toLocaleString("fr-FR");
              requestAnimationFrame(updateCounter);
            } else {
              counter.innerText = "€" + target.toLocaleString("fr-FR");
            }
          };
          updateCounter();
        });
      }
    </script>
  </body>
</html>

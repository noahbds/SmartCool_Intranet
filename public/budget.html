<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Budget & Resources — SmartCool Pro Intranet"
    />
    <meta name="theme-color" content="#3b82f6" />
    <title>Budget | SmartCool Pro</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/budget.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body>
    <script src="js/sidebar.js"></script>
    <script>
      window.si =
        window.si ||
        function () {
          (window.si.q = window.si.q || []).push(arguments);
        };
      window.si("analytics", "auto");
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
    <main class="main-content">
      <header>
        <h1>
          <i
            class="fas fa-coins"
            style="color: var(--accent); margin-right: 10px"
          ></i
          >Budget & Resources
        </h1>
        <p>Financial planning for Prototype and Industrialization phases.</p>
      </header>

      <div
        style="
          display: grid;
          grid-template-columns: 3fr 1fr;
          gap: 24px;
          margin-bottom: 32px;
        "
      >
        <div
          class="card-grid"
          style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"
          id="budget-cards"
        >
          <!-- Cards injected by JS -->
        </div>

        <!-- Visual Chart -->
        <div
          class="card"
          style="
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
          "
        >
          <div class="pie-chart"></div>
          <div style="font-size: 0.8rem; color: var(--text-muted)">
            <span style="color: var(--accent)">●</span>
            CAPEX (<span id="capex-percent">--</span>%) <br />
            <span style="color: #10b981">●</span>
            OPEX (<span id="opex-percent">--</span>%)
          </div>
        </div>
      </div>

      <h2>
        <i class="fas fa-list-ul"></i> Bill of Materials (BOM) - Key Components
      </h2>
      <div class="table-container" style="margin-bottom: 40px">
        <table>
          <thead>
            <tr>
              <th>Component</th>
              <th>Description</th>
              <th>Unit Cost (Est.)</th>
              <th>Supplier</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="bom-body">
            <!-- BOM injected by JS -->
          </tbody>
        </table>
      </div>

      <h2>Detailed Budget Breakdown</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th>Item</th>
              <th>Supplier</th>
              <th>Unit Cost (€)</th>
              <th>Quantity</th>
              <th>Total (€)</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="detailed-budget-body">
            <!-- Budget items injected by JS -->
          </tbody>
        </table>
      </div>

    </main>
    <script>
      fetch("/api/budget")
        .then((res) => res.json())
        .then((data) => {
          // Render Budget Cards
          const cardsContainer = document.getElementById("budget-cards");
          const total = data.summary?.find((s) => s.category === "Total")?.amount || 0;
          const capex = data.summary?.find((s) => s.category === "CAPEX")?.amount || 0;
          const opex = data.summary?.find((s) => s.category === "OPEX")?.amount || 0;

          cardsContainer.innerHTML = `
                <div class="card">
                  <h3>Total Budget</h3>
                  <p class="counter" data-target="${total}" style="font-size: 2rem; font-weight: 700; color: var(--primary); margin: 10px 0;">€0</p>
                  <p style="color: var(--text-muted);"><i class="fas fa-check-circle"></i> Board Approved</p>
                </div>
                <div class="card">
                  <h3>CAPEX (One-time)</h3>
                  <p class="counter" data-target="${capex}" style="font-size: 2rem; font-weight: 700; color: var(--accent); margin: 10px 0;">€0</p>
                  <p style="color: var(--text-muted);">Tooling, Molds</p>
                </div>
                <div class="card">
                  <h3>OPEX (Recurring)</h3>
                  <p class="counter" data-target="${opex}" style="font-size: 2rem; font-weight: 700; color: #10b981; margin: 10px 0;">€0</p>
                  <p style="color: var(--text-muted);">HR, Cloud, BOM</p>
                </div>
              `;

          // Update pie chart with live ratios
          const pie = document.querySelector(".pie-chart");
          const capexPct = Math.round((capex / total) * 100);
          const opexPct = 100 - capexPct;
          pie.style.background = `conic-gradient(var(--accent) 0% ${capexPct}%, #10b981 ${capexPct}% 100%)`;
          document.getElementById("capex-percent").innerText = capexPct;
          document.getElementById("opex-percent").innerText = opexPct;

          // Render BOM
          const bomBody = document.getElementById("bom-body");
          bomBody.innerHTML = (data.bom || [])
            .map(
              (item) => `
                    <tr>
                        <td><i class="fas ${item.icon || 'fa-cube'}"></i> ${
                item.component || 'N/A'
              }</td>
                        <td>${item.description || 'N/A'}</td>
                        <td>€${(item.cost || 0).toFixed(2)}</td>
                        <td>${item.supplier || 'N/A'}</td>
                        <td><span class="status-badge ${
                          item.status === "Sourced"
                            ? "status-done"
                            : "status-wip"
                        }">${item.status}</span></td>
                    </tr>
                `
            )
            .join("");

          // Render detailed budget
          const detailedBody = document.getElementById("detailed-budget-body");
          const budgetItems = [
            ...(data.bom || []).map(item => ({
                category: "BOM (Hardware)",
                item: item.component,
                supplier: item.supplier,
                unitCost: item.cost,
                quantity: 1,
                type: "OPEX"
            })),
            ...(data.staffing || []).map(item => ({
                category: "Staffing",
                item: item.role,
                supplier: "Internal",
                unitCost: item.monthly_cost + item.charges,
                quantity: item.duration,
                type: "OPEX"
            })),
            ...(data.operating || []).map(item => ({
                category: "Operating",
                item: item.item,
                supplier: "Misc",
                unitCost: item.monthly_cost,
                quantity: item.duration,
                type: "OPEX"
            })),
            ...(data.capex || []).map(item => ({
                category: "CAPEX",
                item: item.item,
                supplier: item.supplier,
                unitCost: item.cost,
                quantity: item.quantity,
                type: "CAPEX"
            }))
          ];

          detailedBody.innerHTML = budgetItems
            .map((item) => {
              const total = (item.unitCost * item.quantity).toFixed(2);
              return `
                <tr>
                  <td>${item.category}</td>
                  <td>${item.item}</td>
                  <td>${item.supplier}</td>
                  <td>€${item.unitCost.toFixed(2)}</td>
                  <td>${item.quantity}</td>
                  <td>€${total}</td>
                  <td><span class="status-badge ${
                    item.type === "CAPEX" ? "status-warn" : "status-info"
                  }">${item.type}</span></td>
                </tr>
              `;
            })
            .join("");

          // Initialize Counters
          initCounters();
        });

      function initCounters() {
        const counters = document.querySelectorAll(".counter");
        counters.forEach((counter) => {
          const target = +counter.getAttribute("data-target");
          const duration = 1500;
          const increment = target / (duration / 16);
          let current = 0;
          const updateCounter = () => {
            current += increment;
            if (current < target) {
              counter.innerText =
                "€" + Math.ceil(current).toLocaleString("en-US");
              requestAnimationFrame(updateCounter);
            } else {
              counter.innerText = "€" + target.toLocaleString("en-US");
            }
          };
          updateCounter();
        });
      }
    </script>
  </body>
</html>
